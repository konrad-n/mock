<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SledzSpecke.App.ViewModels.MedicalShifts"
             xmlns:models="clr-namespace:SledzSpecke.App.Models"
             x:DataType="vm:MedicalShiftsListViewModel"
             x:Class="SledzSpecke.App.Views.MedicalShifts.MedicalShiftsListPage"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="HeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource Primary}" />
                <Setter Property="Margin" Value="0,10,0,5" />
            </Style>

            <Style x:Key="ListHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource TextColor}" />
                <Setter Property="Margin" Value="0,5,0,0" />
            </Style>

            <Style x:Key="ColumnHeaderStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource TextMutedColor}" />
                <Setter Property="Margin" Value="0,0,5,0" />
            </Style>

            <Style x:Key="ColumnValueStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="TextColor" Value="{StaticResource TextColor}" />
                <Setter Property="LineBreakMode" Value="TailTruncation" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Dodaj" Command="{Binding AddShiftCommand}" IconImageSource="add.png" />
    </ContentPage.ToolbarItems>

    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Spacing="20" Padding="20">

                <!-- Informacje o module -->
                <Label Text="{Binding ModuleTitle}" FontSize="20" FontAttributes="Bold" />

                <!-- Panel postępu dyżurów -->
                <Frame BorderColor="LightGray" HasShadow="True" CornerRadius="10" Padding="15">
                    <VerticalStackLayout>
                        <Label Text="Postęp dyżurów" Style="{StaticResource HeaderStyle}" />
                        <StackLayout Orientation="Horizontal" Spacing="5">
                            <Label Text="{Binding TotalShiftHours}" FontSize="24" FontAttributes="Bold" />
                            <Label Text="/" FontSize="24" />
                            <Label Text="{Binding RequiredShiftHours}" FontSize="24" />
                            <Label Text="godzin" FontSize="24" VerticalOptions="End" />
                        </StackLayout>
                        <ProgressBar Progress="{Binding ShiftProgress}" Margin="0,10,0,5" />
                    </VerticalStackLayout>
                </Frame>

                <!-- Podsumowanie dyżurów -->
                <Frame BorderColor="LightGray" HasShadow="True" CornerRadius="10" Padding="15">
                    <VerticalStackLayout>
                        <Label Text="Dyżury medyczne - podsumowanie" Style="{StaticResource HeaderStyle}" />

                        <Grid ColumnDefinitions="Auto,*,Auto,*" RowDefinitions="Auto,Auto">
                            <Label Grid.Row="0" Grid.Column="0" Text="Liczba godzin" Style="{StaticResource ColumnHeaderStyle}" />
                            <Label Grid.Row="0" Grid.Column="2" Text="Liczba minut" Style="{StaticResource ColumnHeaderStyle}" />

                            <!-- Stary SMK - "Dyżury zrealizowane", Nowy SMK - "Czas wprowadzony" -->
                            <Label Grid.Row="1" Grid.Column="0" Text="{Binding IsNewSmk, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Czas wprowadzony,Dyżury zrealizowane'}" />
                            <Label Grid.Row="1" Grid.Column="1" Text="{Binding Summary.TotalHours}" FontAttributes="Bold" HorizontalOptions="End" Margin="0,0,20,0" />
                            <Label Grid.Row="1" Grid.Column="3" Text="{Binding Summary.TotalMinutes}" FontAttributes="Bold" HorizontalOptions="End" />
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Wybór stażu (tylko dla nowego SMK) -->
                <Frame IsVisible="{Binding IsNewSmk}" BorderColor="LightGray" HasShadow="True" CornerRadius="10" Padding="15">
                    <VerticalStackLayout>
                        <Label Text="Wybierz staż" Style="{StaticResource HeaderStyle}" />

                        <CollectionView ItemsSource="{Binding Internships}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Internship">
                                    <Grid Padding="5">
                                        <Frame Padding="10" BorderColor="{Binding InternshipId, Converter={StaticResource CodeToColorConverter}, ConverterParameter={Binding Source={RelativeSource AncestorType={x:Type vm:MedicalShiftsListViewModel}}, Path=SelectedInternship.InternshipId}}">
                                            <Frame.GestureRecognizers>
                                                <TapGestureRecognizer 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MedicalShiftsListViewModel}}, Path=SelectInternshipCommand}" 
                                                    CommandParameter="{Binding}" />
                                            </Frame.GestureRecognizers>
                                            <VerticalStackLayout>
                                                <Label Text="{Binding InternshipName}" FontAttributes="Bold" />
                                                <Label Text="{Binding InstitutionName}" FontSize="12" />
                                                <HorizontalStackLayout>
                                                    <Label Text="{Binding StartDate, StringFormat='{0:dd-MM-yyyy}'}" FontSize="12" />
                                                    <Label Text=" - " FontSize="12" />
                                                    <Label Text="{Binding EndDate, StringFormat='{0:dd-MM-yyyy}'}" FontSize="12" />
                                                </HorizontalStackLayout>
                                            </VerticalStackLayout>
                                        </Frame>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Lista dyżurów -->
                <Frame BorderColor="LightGray" HasShadow="True" CornerRadius="10" Padding="15">
                    <VerticalStackLayout>
                        <Label Text="{Binding ShiftsDescription}" Style="{StaticResource HeaderStyle}" />

                        <!-- Label w przypadku braku danych -->
                        <Label Text="Brak danych" IsVisible="{Binding Shifts.Count, Converter={StaticResource StringMatchConverter}, ConverterParameter='0'}" 
                               HorizontalOptions="Center" Margin="0,20" />

                        <!-- Lista dla Nowego SMK -->
                        <CollectionView ItemsSource="{Binding Shifts}" IsVisible="{Binding IsNewSmk}">
                            <CollectionView.Header>
                                <Grid ColumnDefinitions="1*,1*,2*,1*,1*" Padding="5">
                                    <Label Grid.Column="0" Text="Data" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="1" Text="Czas" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="2" Text="Miejsce" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="3" Text="Rok" Style="{StaticResource ColumnHeaderStyle}" />
                                </Grid>
                            </CollectionView.Header>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MedicalShift">
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Usuń" 
                                                           BackgroundColor="{StaticResource DangerColor}" 
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MedicalShiftsListViewModel}}, Path=DeleteShiftCommand}" 
                                                           CommandParameter="{Binding}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>

                                        <Grid ColumnDefinitions="1*,1*,2*,1*,1*" Padding="5">
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MedicalShiftsListViewModel}}, Path=EditShiftCommand}" 
                                                                      CommandParameter="{Binding}" />
                                            </Grid.GestureRecognizers>

                                            <Label Grid.Column="0" Text="{Binding Date, StringFormat='{0:dd-MM-yyyy}'}" Style="{StaticResource ColumnValueStyle}" />
                                            <StackLayout Grid.Column="1" Orientation="Horizontal">
                                                <Label Text="{Binding Hours}" Style="{StaticResource ColumnValueStyle}" />
                                                <Label Text="h " Style="{StaticResource ColumnValueStyle}" />
                                                <Label Text="{Binding Minutes}" Style="{StaticResource ColumnValueStyle}" />
                                                <Label Text="m" Style="{StaticResource ColumnValueStyle}" />
                                            </StackLayout>
                                            <Label Grid.Column="2" Text="{Binding Location}" Style="{StaticResource ColumnValueStyle}" LineBreakMode="TailTruncation" />
                                            <Label Grid.Column="3" Text="{Binding Year}" Style="{StaticResource ColumnValueStyle}" />
                                            <Image Grid.Column="4" Source="edit.png" HeightRequest="20" WidthRequest="20" HorizontalOptions="End" />
                                        </Grid>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- Lista dla Starego SMK -->
                        <CollectionView ItemsSource="{Binding Shifts}" IsVisible="{Binding IsNewSmk, Converter={StaticResource InvertedBoolConverter}}">
                            <CollectionView.Header>
                                <Grid ColumnDefinitions="Auto,Auto,Auto,2*,Auto" Padding="5">
                                    <Label Grid.Column="0" Text="Lp" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="1" Text="Rok szkolenia" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="2" Text="Godziny/minuty" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="3" Text="Data rozpoczęcia" Style="{StaticResource ColumnHeaderStyle}" />
                                    <Label Grid.Column="4" Text="Miejsce" Style="{StaticResource ColumnHeaderStyle}" />
                                </Grid>
                            </CollectionView.Header>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MedicalShift">
                                    <SwipeView>
                                        <SwipeView.RightItems>
                                            <SwipeItems>
                                                <SwipeItem Text="Usuń" 
                                                           BackgroundColor="{StaticResource DangerColor}" 
                                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MedicalShiftsListViewModel}}, Path=DeleteShiftCommand}" 
                                                           CommandParameter="{Binding}" />
                                            </SwipeItems>
                                        </SwipeView.RightItems>

                                        <Grid ColumnDefinitions="Auto,Auto,Auto,2*,Auto" Padding="5">
                                            <Grid.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MedicalShiftsListViewModel}}, Path=EditShiftCommand}" 
                                                                      CommandParameter="{Binding}" />
                                            </Grid.GestureRecognizers>

                                            <Label Grid.Column="0" Text="{Binding ShiftId}" Style="{StaticResource ColumnValueStyle}" />
                                            <Label Grid.Column="1" Text="{Binding Year, StringFormat='Rok {0}'}" Style="{StaticResource ColumnValueStyle}" Margin="5,0" />
                                            <StackLayout Grid.Column="2" Orientation="Horizontal">
                                                <Label Text="{Binding Hours}" Style="{StaticResource ColumnValueStyle}" />
                                                <Label Text="h " Style="{StaticResource ColumnValueStyle}" />
                                                <Label Text="{Binding Minutes}" Style="{StaticResource ColumnValueStyle}" />
                                                <Label Text="m" Style="{StaticResource ColumnValueStyle}" />
                                            </StackLayout>
                                            <Label Grid.Column="3" Text="{Binding Date, StringFormat='{0:yyyy-MM-dd}'}" Style="{StaticResource ColumnValueStyle}" Margin="5,0" />
                                            <Label Grid.Column="4" Text="{Binding Location}" Style="{StaticResource ColumnValueStyle}" LineBreakMode="TailTruncation" MaximumWidthRequest="150" />
                                        </Grid>
                                    </SwipeView>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
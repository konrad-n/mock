<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SledzSpecke.App.ViewModels.Procedures"
             xmlns:models="clr-namespace:SledzSpecke.App.Models"
             x:DataType="vm:NewSMKProceduresListViewModel"
             x:Class="SledzSpecke.App.Views.Procedures.NewSMKProceduresListPage"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <Style x:Key="HeaderText" TargetType="Label">
                <Setter Property="FontSize" Value="16" />
                <Setter Property="FontAttributes" Value="Bold" />
                <Setter Property="TextColor" Value="{StaticResource Primary}" />
                <Setter Property="Margin" Value="0,10,0,5" />
            </Style>

            <Style x:Key="RequirementTitle" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="LineBreakMode" Value="WordWrap" />
            </Style>

            <Style x:Key="TableHeader" TargetType="Label">
                <Setter Property="FontSize" Value="12" />
                <Setter Property="TextColor" Value="{StaticResource TextMutedColor}" />
                <Setter Property="HorizontalTextAlignment" Value="Center" />
            </Style>

            <Style x:Key="TableCell" TargetType="Label">
                <Setter Property="FontSize" Value="14" />
                <Setter Property="HorizontalTextAlignment" Value="Center" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <RefreshView IsRefreshing="{Binding IsRefreshing}" Command="{Binding RefreshCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="15">
                <!-- NagÅ‚Ã³wek i przeÅ‚Ä…cznik moduÅ‚Ã³w -->
                <Label Text="{Binding ModuleTitle}" Style="{StaticResource HeaderText}" />

                <StackLayout IsVisible="{Binding HasTwoModules}" 
                           Orientation="Horizontal" 
                           HorizontalOptions="Center" 
                           Margin="0,10" 
                           Spacing="10">
                    <Label Text="Aktywny moduÅ‚:" 
                           VerticalOptions="Center" 
                           FontAttributes="Bold" />
                    <Frame Padding="0" 
                           CornerRadius="5" 
                           BorderColor="{StaticResource Primary}" 
                           HasShadow="False">
                        <Grid ColumnDefinitions="*,*">
                            <Button Text="Podstawowy" 
                                    BackgroundColor="{Binding BasicModuleSelected, Converter={StaticResource BoolToColorConverter}}"
                                    TextColor="{Binding BasicModuleSelected, Converter={StaticResource BoolToTextColorConverter}}"
                                    Command="{Binding SelectModuleCommand}" 
                                    CommandParameter="Basic" />
                            <Button Grid.Column="1" 
                                    Text="Specjalistyczny" 
                                    BackgroundColor="{Binding SpecialisticModuleSelected, Converter={StaticResource BoolToColorConverter}}"
                                    TextColor="{Binding SpecialisticModuleSelected, Converter={StaticResource BoolToTextColorConverter}}"
                                    Command="{Binding SelectModuleCommand}" 
                                    CommandParameter="Specialistic" />
                        </Grid>
                    </Frame>
                </StackLayout>

                <!-- Lista wymagaÅ„ -->
                <CollectionView ItemsSource="{Binding ProcedureRequirements}"
                              RemainingItemsThreshold="2"
                              RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">
                    <CollectionView.EmptyView>
                        <StackLayout HorizontalOptions="Center" VerticalOptions="Center">
                            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                             IsVisible="{Binding IsLoading}" />
                            <Label Text="Brak procedur do wyÅ›wietlenia" 
                                   IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                   TextColor="{StaticResource TextMutedColor}" />
                        </StackLayout>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="vm:ProcedureRequirementViewModel">
                            <Frame Style="{StaticResource CardFrame}" 
                                   Margin="0,5" 
                                   Padding="15">
                                <VerticalStackLayout Spacing="10">
                                    <!-- NagÅ‚Ã³wek wymagania -->
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Text="{Binding Title}" 
                                               Style="{StaticResource RequirementTitle}" />
                                        <Button Grid.Column="1" 
                                                Text="â–¼"
                                                Command="{Binding ToggleExpandCommand}"
                                                HeightRequest="30"
                                                WidthRequest="30"
                                                Padding="0"
                                                CornerRadius="15"
                                                BackgroundColor="{StaticResource Primary}"
                                                TextColor="White" />
                                    </Grid>

                                    <!-- RozwiniÄ™ta sekcja -->
                                    <VerticalStackLayout IsVisible="{Binding IsExpanded}" 
                                                       Spacing="15">
                                        <!-- Zabiegi/procedury wykonane samodzielnie -->
                                        <VerticalStackLayout>
                                            <Label Text="Zabiegi/procedury wykonane samodzielnie" 
                                                   FontAttributes="Bold" />
                                            <Grid ColumnDefinitions="*,*,*">
                                                <VerticalStackLayout Grid.Column="0">
                                                    <Label Text="Wymagane" 
                                                           Style="{StaticResource TableHeader}" />
                                                    <Label Text="{Binding Statistics.RequiredCountA}" 
                                                           Style="{StaticResource TableCell}" />
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="1">
                                                    <Label Text="Wprowadzone" 
                                                           Style="{StaticResource TableHeader}" />
                                                    <Label Text="{Binding Statistics.CompletedCountA}" 
                                                           Style="{StaticResource TableCell}" />
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="2">
                                                    <Label Text="PozostaÅ‚o do zrealizowania" 
                                                           Style="{StaticResource TableHeader}" />
                                                    <Label Text="{Binding Statistics.RemainingCountA}" 
                                                           Style="{StaticResource TableCell}" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- Zabiegi/procedury wykonane jako pierwsza asysta -->
                                        <VerticalStackLayout>
                                            <Label Text="Zabiegi/procedury wykonane jako pierwsza asysta" 
                                                   FontAttributes="Bold" />
                                            <Grid ColumnDefinitions="*,*,*">
                                                <VerticalStackLayout Grid.Column="0">
                                                    <Label Text="Wymagane" 
                                                           Style="{StaticResource TableHeader}" />
                                                    <Label Text="{Binding Statistics.RequiredCountB}" 
                                                           Style="{StaticResource TableCell}" />
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="1">
                                                    <Label Text="Wprowadzone" 
                                                           Style="{StaticResource TableHeader}" />
                                                    <Label Text="{Binding Statistics.CompletedCountB}" 
                                                           Style="{StaticResource TableCell}" />
                                                </VerticalStackLayout>
                                                <VerticalStackLayout Grid.Column="2">
                                                    <Label Text="PozostaÅ‚o do zrealizowania" 
                                                           Style="{StaticResource TableHeader}" />
                                                    <Label Text="{Binding Statistics.RemainingCountB}" 
                                                           Style="{StaticResource TableCell}" />
                                                </VerticalStackLayout>
                                            </Grid>
                                        </VerticalStackLayout>

                                        <!-- Przycisk dodawania realizacji -->
                                        <Button Text="Dodaj realizacjÄ™"
                                                Command="{Binding ToggleAddRealizationCommand}"
                                                IsVisible="{Binding IsAddingRealization, Converter={StaticResource InvertedBoolConverter}}"
                                                Style="{StaticResource PrimaryButton}"
                                                HorizontalOptions="Start" />

                                        <!-- Lista realizacji -->
                                        <VerticalStackLayout IsVisible="{Binding IsExpanded}">
                                            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                       IsVisible="{Binding IsLoading}" 
                       HorizontalOptions="Center" />

                                            <Label Text="Lista realizacji" 
           FontAttributes="Bold" 
           Margin="0,10,0,5"
           IsVisible="{Binding HasRealizations}" />

                                            <Grid ColumnDefinitions="*,*,2*,Auto" 
          Padding="5"
          IsVisible="{Binding HasRealizations}">
                                                <Label Text="Wykonane samodzielnie" 
               Style="{StaticResource TableHeader}" 
               Grid.Column="0" />
                                                <Label Text="Wykonane jako asysta" 
               Style="{StaticResource TableHeader}" 
               Grid.Column="1" />
                                                <Label Text="Daty realizacji" 
               Style="{StaticResource TableHeader}" 
               Grid.Column="2" />
                                            </Grid>

                                            <CollectionView ItemsSource="{Binding Realizations}"
                   IsVisible="{Binding HasRealizations}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="models:RealizedProcedureNewSMK">
                                                        <Grid ColumnDefinitions="*,*,2*,Auto" 
                      Padding="5">
                                                            <Label Text="{Binding CountA}" 
                           Grid.Column="0" 
                           Style="{StaticResource TableCell}" />
                                                            <Label Text="{Binding CountB}" 
                           Grid.Column="1" 
                           Style="{StaticResource TableCell}" />
                                                            <Label Text="{Binding DateRange}" 
                           Grid.Column="2" 
                           Style="{StaticResource TableCell}" />
                                                            <StackLayout Grid.Column="3" 
                                                                        Orientation="Horizontal" 
                                                                        Spacing="5">
                                                                <Button Text="âœï¸" 
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProcedureRequirementViewModel}}, Path=EditRealizationCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        Style="{StaticResource LightIconButton}" />
                                                                <Button Text="ðŸ—‘ï¸" 
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProcedureRequirementViewModel}}, Path=DeleteRealizationCommand}"
                                                                        CommandParameter="{Binding .}"
                                                                        Style="{StaticResource LightIconButton}"
                                                                        BackgroundColor="{StaticResource DangerColor}" />
                                                            </StackLayout>
                                                        </Grid>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                                <CollectionView.EmptyView>
                                                    <Label Text="Brak realizacji" 
                                                           Style="{StaticResource TextMutedColor}"
                                                           HorizontalOptions="Center" />
                                                </CollectionView.EmptyView>
                                            </CollectionView>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>